from django.http.response import HttpResponse

from django.shortcuts import render

from random import choice

from . form import NormalForm

from .normal_form import Guess, TruthTable, Question, DISJUNCTION, CONJUNCTION
from .assessment import BooleanAssessment
from ..core import generateNumbers


QUESTION_KEY = 'question'

def render_question(request, question, answer, correction = None):
    params = {
        'question': question,
        'table': question.function.table.to_html(),
        'input': answer,
    }
    if correction:
        params['correction'] = correction,

    return render(request, 'normal_form.html', params)


def normal_form(request):
    if request.method == 'POST':
        assessment = BooleanAssessment()

        question = Question.from_dict(request.session[QUESTION_KEY])
        answer = NormalForm(question, request.POST)

        if answer.is_valid():
            guess = answer.cleaned_data['guess']
            return render(
                request,
                guess.question,
                answer,
                "You are correct!"
            )
        else:
            return HttpResponse(answer.errors.get('guess'))

    else:
        variables = {"a", "b"}
        results = generateNumbers(1, 2**len(variables))
        table = TruthTable.create(variables, "f", results)
        normal_form = choice([DISJUNCTION, CONJUNCTION])

        question = Question(normal_form, table)

        request.session[QUESTION_KEY] = question.to_dict()

        return render(
            request,
            question,
            NormalForm(question),
        )
